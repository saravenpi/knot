# Docker Compose for Knot development environment
version: '3.8'

services:
  # Knot development environment
  knot-dev:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: knot-dev
    volumes:
      - .:/workspace/knot:ro
      - knot-projects:/workspace/projects
    working_dir: /workspace/projects
    environment:
      - KNOT_REPO_URL=https://github.com/saravenpi/knot.git
    command: info
    profiles:
      - dev

  # Knot build environment
  knot-build:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: knot-build
    volumes:
      - .:/usr/src/knot
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/usr/src/knot/target
    working_dir: /usr/src/knot
    command: cargo build --release
    profiles:
      - build

  # Test runner
  knot-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: knot-test
    volumes:
      - .:/usr/src/knot
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/usr/src/knot/target
    working_dir: /usr/src/knot
    command: cargo test
    profiles:
      - test

  # Documentation server
  docs:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: knot-docs
    ports:
      - "8000:8000"
    volumes:
      - .:/usr/src/knot
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/usr/src/knot/target
    working_dir: /usr/src/knot
    command: bash -c "cargo doc --no-deps && python3 -m http.server 8000 -d target/doc"
    profiles:
      - docs

volumes:
  knot-projects:
    driver: local
  cargo-cache:
    driver: local
  target-cache:
    driver: local